<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Peptide Log Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: { background: '#0f172a', surface: '#1e293b', primary: '#6366f1' }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%); color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .input-field { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.2); color: white; border-radius: 1rem; padding: 0.75rem 1rem; width: 100%; font-size: 16px; }
        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); transition: all 0.2s; }
        .btn-primary:active { transform: scale(0.95); }
        .nav-pill.active { background: #6366f1; color: white; }
        /* Seringue style */
        .syringe-container { position: relative; width: 50px; height: 200px; border: 2px solid #475569; border-radius: 0 0 10px 10px; overflow: hidden; background: rgba(255,255,255,0.05); }
        .liquid { position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, #ef4444, #f87171); transition: height 0.5s; }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen pb-10">

    <div id="setup-screen" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-6 hidden">
        <div class="glass-card w-full max-w-md p-8 rounded-3xl text-center space-y-6">
            <h2 class="text-2xl font-bold">Connect Spreadsheet</h2>
            <input type="url" id="setup-url" placeholder="https://script.google.com/..." class="input-field">
            <button onclick="saveUrl()" class="btn-primary w-full py-4 rounded-2xl font-bold">Connect App</button>
        </div>
    </div>

    <div id="app-container" class="w-full max-w-lg hidden">
        <header class="p-6 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-indigo-300">Peptide Log</h1>
            <div id="status-label" class="text-xs text-slate-500">Ready</div>
        </header>

        <nav class="px-4 mb-4">
            <div class="flex bg-slate-800/50 p-1 rounded-2xl border border-slate-700/50">
                <button onclick="switchView('log')" id="tab-log" class="nav-pill active flex-1 py-2 rounded-xl text-sm font-medium transition">Log</button>
                <button onclick="switchView('history')" id="tab-history" class="nav-pill flex-1 py-2 rounded-xl text-sm font-medium transition">History</button>
                <button onclick="switchView('calculator')" id="tab-calculator" class="nav-pill flex-1 py-2 rounded-xl text-sm font-medium transition">Calc</button>
                <button onclick="switchView('config')" id="tab-config" class="nav-pill flex-1 py-2 rounded-xl text-sm font-medium transition">Config</button>
            </div>
        </nav>

        <main class="px-4 space-y-6">
            
            <div id="view-log" class="space-y-6">
                <div id="suggestion-box" class="glass-card p-4 rounded-2xl border-l-4 border-l-indigo-500 flex justify-between items-center hidden">
                    <div>
                        <p class="text-[10px] text-indigo-400 font-bold uppercase">Next recommended site</p>
                        <p id="suggestion-text" class="text-lg font-bold">--</p>
                    </div>
                    <button onclick="useSuggestion()" class="bg-indigo-600 px-4 py-2 rounded-lg text-xs font-bold">Use</button>
                </div>

                <section>
                    <h2 class="text-xs font-bold text-slate-500 uppercase mb-3 ml-1">Quick Actions</h2>
                    <div id="quick-log-container" class="grid grid-cols-2 gap-3"></div>
                </section>

                <form id="log-form" class="glass-card p-6 rounded-3xl space-y-4">
                    <select id="log-peptide" class="input-field"><option value="">Select Peptide</option></select>
                    <div class="flex gap-2">
                        <input type="number" id="log-dosage" placeholder="Dose" class="input-field flex-1">
                        <select id="log-unit" class="bg-slate-800 border border-slate-700 rounded-xl px-2 text-sm">
                            <option>mcg</option><option>mg</option><option>IU</option>
                        </select>
                    </div>
                    <select id="log-site" class="input-field"></select>
                    <input type="text" id="log-notes" placeholder="Notes (optional)" class="input-field">
                    <input type="datetime-local" id="log-time" class="input-field" style="color-scheme: dark;">
                    <button type="submit" class="btn-primary w-full py-4 rounded-2xl font-bold">Log Injection</button>
                </form>
            </div>

            <div id="view-history" class="hidden space-y-4">
                <input type="text" id="history-filter" placeholder="Filter history..." class="input-field" oninput="renderHistory()">
                <div id="history-list" class="space-y-3 pb-10"></div>
            </div>

            <div id="view-calculator" class="hidden">
                <div class="glass-card p-6 rounded-3xl flex flex-col items-center">
                    <div class="syringe-container mb-4">
                        <div id="visual-liquid" class="liquid" style="height: 0%"></div>
                    </div>
                    <div class="text-center">
                        <p class="text-slate-400 text-sm">Draw to mark</p>
                        <p id="calc-result" class="text-5xl font-black">0</p>
                        <p class="text-slate-500 text-xs mt-1">Units (IU)</p>
                    </div>
                    <div class="w-full grid grid-cols-2 gap-4 mt-6">
                        <input type="number" id="calc-vial" placeholder="Vial mg" class="input-field" oninput="runCalc()">
                        <input type="number" id="calc-water" placeholder="Water mL" class="input-field" oninput="runCalc()">
                        <input type="number" id="calc-dose" placeholder="Target mcg" class="input-field col-span-2" oninput="runCalc()">
                    </div>
                </div>
            </div>

            <div id="view-config" class="hidden space-y-6">
                <section class="glass-card p-6 rounded-3xl">
                    <h2 class="font-bold mb-4">My Preferred Sites</h2>
                    <div id="preferred-sites-grid" class="grid grid-cols-2 gap-2"></div>
                    <p class="text-[10px] text-slate-500 mt-4 italic">* Suggestions will only cycle through these sites.</p>
                </section>

                <section class="glass-card p-6 rounded-3xl">
                    <h2 class="font-bold mb-4">Add New Quick Log</h2>
                    <form id="config-form" class="space-y-3">
                        <input type="text" id="conf-label" placeholder="Label (ex: Daily BPC)" class="input-field" required>
                        <input type="text" id="conf-peptide" placeholder="Peptide Name" class="input-field" required>
                        <div class="flex gap-2">
                            <input type="number" id="conf-val" placeholder="Value" class="input-field flex-1" required>
                            <select id="conf-unit" class="bg-slate-800 border border-slate-700 rounded-xl px-2">
                                <option>mcg</option><option>mg</option><option>IU</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-primary w-full py-3 rounded-2xl font-bold">Save Preset</button>
                    </form>
                </section>

                <section>
                    <h2 class="text-xs font-bold text-slate-500 uppercase mb-3 ml-1">Existing Presets</h2>
                    <div id="presets-list" class="space-y-2"></div>
                </section>

                <button onclick="resetApp()" class="w-full py-4 text-red-500 text-sm font-bold border border-red-900/30 rounded-2xl">Reset App / URL</button>
            </div>
        </main>
    </div>

    <div id="site-modal" class="fixed inset-0 z-50 bg-slate-900/90 hidden flex items-center justify-center p-6">
        <div class="glass-card w-full max-w-sm p-6 rounded-3xl space-y-4">
            <h3 class="font-bold text-center">Select Injection Site</h3>
            <div id="modal-sites" class="grid grid-cols-2 gap-2 max-h-96 overflow-y-auto"></div>
            <button onclick="closeModal()" class="w-full py-3 text-slate-400">Cancel</button>
        </div>
    </div>

    <script>
        let APP_URL = localStorage.getItem('pep_url');
        let history = [];
        let presets = [];
        let preferredSites = JSON.parse(localStorage.getItem('pref_sites')) || [
            "Right Abdomen (Lower)", "Left Abdomen (Lower)", "Right Flank", "Left Flank"
        ];

        const ALL_SITES = [
            "Right Abdomen (Upper)", "Right Abdomen (Lower)", "Left Abdomen (Upper)", "Left Abdomen (Lower)",
            "Right Flank", "Left Flank", "Right Thigh", "Left Thigh", "Right Deltoid", "Left Deltoid",
            "Right Buttock", "Left Buttock", "Nasal Spray", "Other"
        ];

        function saveUrl() {
            const url = document.getElementById('setup-url').value;
            if(url) { localStorage.setItem('pep_url', url); location.reload(); }
        }

        function resetApp() { if(confirm("Disconnect?")) { localStorage.removeItem('pep_url'); location.reload(); } }

        async function api(data) {
            try {
                const res = await fetch(APP_URL, { method: 'POST', body: JSON.stringify(data) });
                return await res.json();
            } catch(e) { alert("Network error"); return {success:false}; }
        }

        function switchView(view) {
            document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('view-' + view).classList.remove('hidden');
            document.querySelectorAll('.nav-pill').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + view).classList.add('active');
            if(view === 'history') loadHistory();
            if(view === 'log') { loadPresets(); loadHistory(); }
            if(view === 'config') { renderPrefSites(); renderPresetsList(); }
        }

        function renderPrefSites() {
            const container = document.getElementById('preferred-sites-grid');
            container.innerHTML = '';
            ALL_SITES.forEach(s => {
                const isActive = preferredSites.includes(s);
                const btn = document.createElement('button');
                btn.className = `p-2 text-[10px] rounded-lg border transition ${isActive ? 'bg-indigo-600 border-indigo-400' : 'bg-slate-800 border-slate-700 text-slate-500'}`;
                btn.textContent = s;
                btn.onclick = () => {
                    if(preferredSites.includes(s)) preferredSites = preferredSites.filter(x => x !== s);
                    else preferredSites.push(s);
                    localStorage.setItem('pref_sites', JSON.stringify(preferredSites));
                    renderPrefSites();
                    calculateSuggestion();
                };
                container.appendChild(btn);
            });
        }

        async function loadPresets() {
            const res = await fetch(`${APP_URL}?action=getPresets`).then(r => r.json());
            if(res.success) {
                presets = res.presets;
                const container = document.getElementById('quick-log-container');
                container.innerHTML = '';
                const select = document.getElementById('log-peptide');
                select.innerHTML = '<option value="">Select Peptide</option>';
                
                res.presets.forEach(p => {
                    const btn = document.createElement('button');
                    btn.className = "glass-card p-4 rounded-2xl text-left border border-slate-700 active:bg-indigo-600 transition";
                    btn.innerHTML = `<p class="font-bold text-sm">${p.label}</p><p class="text-[10px] text-slate-400">${p.value}${p.unit}</p>`;
                    btn.onclick = () => openSiteModal(p);
                    container.appendChild(btn);

                    const opt = document.createElement('option');
                    opt.value = p.peptide; opt.textContent = p.peptide;
                    select.appendChild(opt);
                });
            }
        }

        function renderPresetsList() {
            const container = document.getElementById('presets-list');
            container.innerHTML = '';
            presets.forEach(p => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center glass-card p-3 rounded-xl";
                div.innerHTML = `<div><p class="text-sm font-bold">${p.label}</p><p class="text-[10px] text-slate-500">${p.peptide}</p></div>
                <button onclick="deletePreset(${p.row})" class="text-red-500 p-2">✕</button>`;
                container.appendChild(div);
            });
        }

        async function deletePreset(row) {
            if(!confirm("Delete this preset?")) return;
            const res = await api({ action: 'deleteConfig', row: row });
            if(res.success) loadPresets().then(renderPresetsList);
        }

        let pendingQuickLog = null;
        function openSiteModal(p) {
            pendingQuickLog = p;
            const container = document.getElementById('modal-sites');
            container.innerHTML = '';
            ALL_SITES.forEach(s => {
                const btn = document.createElement('button');
                btn.className = "bg-slate-800 p-3 rounded-xl text-xs hover:bg-indigo-600";
                btn.textContent = s;
                btn.onclick = () => finalizeQuickLog(s);
                container.appendChild(btn);
            });
            document.getElementById('site-modal').classList.remove('hidden');
        }

        async function finalizeQuickLog(site) {
            document.getElementById('site-modal').classList.add('hidden');
            const data = {
                peptide: pendingQuickLog.peptide,
                dosage: `${pendingQuickLog.value} ${pendingQuickLog.unit}`,
                site: site,
                timestamp: new Date().toISOString()
            };
            const res = await api(data);
            if(res.success) { alert("Logged!"); loadHistory(); }
        }

        async function loadHistory() {
            const res = await fetch(`${APP_URL}?action=getHistory`).then(r => r.json());
            if(res.success) {
                history = res.history;
                renderHistory();
                calculateSuggestion();
            }
        }

        function renderHistory() {
            const filter = document.getElementById('history-filter').value.toLowerCase();
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            history.filter(h => h.peptide.toLowerCase().includes(filter) || h.site.toLowerCase().includes(filter))
            .forEach(h => {
                const date = new Date(h.date).toLocaleDateString('fr-FR', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
                const card = document.createElement('div');
                card.className = "glass-card p-4 rounded-2xl flex justify-between items-center border border-slate-800";
                card.innerHTML = `<div>
                    <p class="font-bold text-sm">${h.peptide} <span class="text-indigo-400 ml-2">${h.dosage}</span></p>
                    <p class="text-[10px] text-slate-500">${h.site} • ${date}</p>
                </div>
                <button onclick="deleteLog(${h.row})" class="text-slate-600">✕</button>`;
                container.appendChild(card);
            });
        }

        async function deleteLog(row) {
            if(!confirm("Delete log?")) return;
            const res = await api({action:'deleteLog', row:row});
            if(res.success) loadHistory();
        }

        function calculateSuggestion() {
            if (preferredSites.length === 0) {
                document.getElementById('suggestion-box').classList.add('hidden');
                return;
            }

            // Trouver le site préféré qui a été utilisé il y a le plus longtemps
            let bestSite = preferredSites[0];
            let oldestDate = new Date();

            // On cherche parmis les sites préférés
            const siteUsage = {};
            preferredSites.forEach(s => siteUsage[s] = new Date(0)); // Init à l'an 0

            history.forEach(h => {
                if (siteUsage.hasOwnProperty(h.site)) {
                    const d = new Date(h.date);
                    if (d > siteUsage[h.site]) siteUsage[h.site] = d;
                }
            });

            // On prend celui dont la date d'utilisation est la plus ancienne
            let minDate = new Date();
            for (const [site, lastUsed] of Object.entries(siteUsage)) {
                if (lastUsed < minDate) {
                    minDate = lastUsed;
                    bestSite = site;
                }
            }

            document.getElementById('suggestion-text').textContent = bestSite;
            document.getElementById('suggestion-box').classList.remove('hidden');
        }

        function useSuggestion() {
            document.getElementById('log-site').value = document.getElementById('suggestion-text').textContent;
        }

        function runCalc() {
            const v = document.getElementById('calc-vial').value;
            const w = document.getElementById('calc-water').value;
            const d = document.getElementById('calc-dose').value;
            if(v && w && d) {
                const units = (d / (v * 1000 / w)) * 100;
                document.getElementById('calc-result').textContent = Math.round(units);
                document.getElementById('visual-liquid').style.height = Math.min(units, 100) + '%';
            }
        }

        // Init
        if(!APP_URL) {
            document.getElementById('setup-screen').classList.remove('hidden');
        } else {
            document.getElementById('app-container').classList.remove('hidden');
            // Fill site selects
            const s1 = document.getElementById('log-site');
            ALL_SITES.forEach(s => {
                const o = document.createElement('option'); o.value = s; o.textContent = s;
                s1.appendChild(o);
            });
            document.getElementById('log-time').value = new Date().toISOString().slice(0,16);
            
            // Events
            document.getElementById('log-form').onsubmit = async (e) => {
                e.preventDefault();
                const data = {
                    peptide: document.getElementById('log-peptide').value,
                    dosage: document.getElementById('log-dosage').value + ' ' + document.getElementById('log-unit').value,
                    site: document.getElementById('log-site').value,
                    timestamp: document.getElementById('log-time').value,
                    notes: document.getElementById('log-notes').value
                };
                const res = await api(data);
                if(res.success) { alert("Logged!"); loadHistory(); e.target.reset(); }
            };

            document.getElementById('config-form').onsubmit = async (e) => {
                e.preventDefault();
                const data = {
                    action: 'saveConfig',
                    label: document.getElementById('conf-label').value,
                    peptide: document.getElementById('conf-peptide').value,
                    value: document.getElementById('conf-val').value,
                    unit: document.getElementById('conf-unit').value
                };
                const res = await api(data);
                if(res.success) { alert("Preset Saved!"); loadPresets(); e.target.reset(); }
            };

            switchView('log');
        }

        function closeModal() { document.getElementById('site-modal').classList.add('hidden'); }
    </script>
</body>
</html>
