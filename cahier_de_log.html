<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Peptide Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        gray: { 750: '#2d3748', 850: '#1a202c', 900: '#111827', 950: '#030712' },
                        primary: { 500: '#6366f1', 600: '#4f46e5' }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #030712; color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        
        .card { background-color: #111827; border: 1px solid #1f2937; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* Suggestion Card Style (New) */
        .suggestion-card {
            background: linear-gradient(145deg, #1e1b4b 0%, #111827 100%);
            border: 1px solid #312e81;
            border-radius: 1rem;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
        }
        .suggestion-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: #6366f1;
        }

        .input-field { background-color: #1f2937; border: 1px solid #374151; color: white; border-radius: 0.75rem; padding: 0.875rem 1rem 0.875rem 2.75rem; width: 100%; font-size: 16px; transition: border-color 0.2s; }
        .input-field:focus { border-color: #6366f1; outline: none; ring: 1px solid #6366f1; }
        .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; }
        
        select.input-field { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3c/svg%3e"); background-position: right 1rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
        select.input-field option { background-color: #1f2937; color: white; padding: 8px; }
        select.input-field optgroup { background-color: #111827; color: #9ca3af; font-weight: bold; }

        .btn-primary { background-color: #6366f1; color: white; font-weight: 600; border-radius: 0.75rem; padding: 1rem; transition: background-color 0.2s; box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.2); }
        .btn-primary:active { transform: translateY(1px); }

        .tab-nav { background-color: #111827; border: 1px solid #1f2937; border-radius: 1rem; padding: 0.25rem; display: flex; }
        .tab-btn { flex: 1; padding: 0.75rem; font-size: 0.875rem; font-weight: 500; color: #9ca3af; text-align: center; border-radius: 0.75rem; transition: all 0.2s; }
        .tab-btn.active { background-color: #1f2937; color: white; font-weight: 600; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }

        .unit-select { background-color: #374151; color: white; border: 1px solid #4b5563; border-left: none; border-radius: 0 0.75rem 0.75rem 0; padding: 0 1rem; font-weight: 500; }
        
        .btn-quick { background-color: #1f2937; border: 1px solid #374151; color: white; border-radius: 0.75rem; padding: 1rem; text-align: left; transition: all 0.2s; display: flex; flex-direction: column; gap: 0.25rem; }
        .btn-quick:active { background-color: #374151; border-color: #6366f1; }

        #site-modal { backdrop-filter: blur(4px); }
        .modal-content { background-color: #111827; border: 1px solid #374151; border-radius: 1.5rem 1.5rem 0 0; }
        @media (min-width: 640px) { .modal-content { border-radius: 1rem; } }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen pb-10">

    <!-- SETUP SCREEN -->
    <div id="setup-screen" class="fixed inset-0 z-50 bg-gray-950 flex items-center justify-center p-6 hidden">
        <div class="w-full max-w-md card text-center space-y-6">
            <div class="w-16 h-16 bg-indigo-500/10 rounded-2xl flex items-center justify-center mx-auto text-indigo-500">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
            </div>
            <h2 class="text-2xl font-bold text-white">Connexion</h2>
            <p class="text-gray-400">Entrez l'URL de votre script Google pour commencer.</p>
            <form id="setup-form" class="space-y-4 text-left">
                <div class="relative">
                    <svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                    <input type="url" id="setup-url" required placeholder="https://script.google.com/..." class="input-field">
                </div>
                <button type="submit" class="btn-primary w-full">Connecter</button>
            </form>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="w-full max-w-lg flex flex-col h-full hidden animate-fade-in">
        
        <header class="pt-8 pb-6 px-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-white tracking-tight">Peptide Log</h1>
                <p id="status-text" class="text-sm text-gray-500 flex items-center gap-2 mt-1">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span> Pr√™t
                </p>
            </div>
            <button id="refresh-app" class="p-3 bg-gray-800 border border-gray-700 rounded-xl text-gray-400 hover:text-white active:bg-gray-700 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
            </button>
        </header>

        <nav class="px-4 mb-6">
            <div class="tab-nav">
                <button id="tab-log" class="tab-btn active" onclick="switchTab('log')">Log</button>
                <button id="tab-history" class="tab-btn" onclick="switchTab('history')">Historique</button>
                <button id="tab-calculator" class="tab-btn" onclick="switchTab('calculator')">Calc</button>
                <button id="tab-config" class="tab-btn" onclick="switchTab('config')">Config</button>
            </div>
        </nav>

        <main class="flex-1 px-4 space-y-6 pb-20">
            
            <!-- LOG TAB -->
            <div id="view-log" class="space-y-6">
                
                <!-- === NOUVEAU : CARTE SUGGESTION === -->
                <div id="suggestion-box" class="suggestion-card flex justify-between items-center hidden">
                    <div>
                        <p class="text-indigo-400 text-xs font-bold uppercase tracking-wider mb-1">Rotation Sugg√©r√©e</p>
                        <p id="suggestion-text" class="text-white font-semibold text-lg">Chargement...</p>
                    </div>
                    <button onclick="useSuggestion()" class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold py-2 px-4 rounded-lg transition shadow-lg shadow-indigo-500/30">
                        Utiliser
                    </button>
                </div>
                <!-- ================================== -->

                <!-- Streak Tracker -->
                <div class="card flex justify-between items-center py-4">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">S√©rie 7 Jours</span>
                    <div id="streak-container" class="flex gap-2">
                        <div class="w-8 h-8 rounded-full bg-gray-800 animate-pulse"></div>
                    </div>
                </div>

                <!-- Quick Log -->
                <section>
                    <h2 class="text-sm font-bold text-indigo-400 uppercase tracking-wider mb-3 ml-1">Raccourcis (Quick Log)</h2>
                    <div id="quick-log-buttons" class="grid grid-cols-2 gap-3">
                        <div class="col-span-2 p-8 text-center border border-dashed border-gray-800 rounded-xl">
                            <p class="text-gray-600 text-sm">Chargement...</p>
                        </div>
                    </div>
                </section>

                <!-- Manual Log -->
                <section class="card">
                    <h2 class="text-sm font-bold text-indigo-400 uppercase tracking-wider mb-4">Saisie Manuelle</h2>
                    <form id="log-form" class="space-y-4">
                        <div class="relative">
                            <svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                            <select id="peptide-name" required class="input-field">
                                <option value="" disabled selected>S√©lectionner Peptide</option>
                                <option value="Tirzepatide">Tirzepatide</option>
                                <option value="BPC 157">BPC 157</option>
                                <option value="CJC-1295 + Ipamorelin">CJC-1295 + Ipamorelin</option>
                                <option value="GHK-Cu">GHK-Cu</option>
                                <option value="Semax">Semax</option>
                                <option value="Selank">Selank</option>
                                <option value="Other">Autre (Perso)</option>
                            </select>
                        </div>
                        
                        <div id="custom-peptide-group" class="hidden">
                            <div class="relative">
                                <svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                <input type="text" id="custom-peptide" placeholder="Nom du peptide..." class="input-field">
                            </div>
                        </div>

                        <div class="flex">
                            <div class="relative flex-1">
                                <svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547" /></svg>
                                <input type="number" id="dosage-value" min="0.01" step="0.01" placeholder="Dose" class="input-field rounded-r-none border-r-0">
                            </div>
                            <select id="dosage-unit" class="unit-select w-24">
                                <option value="mcg">mcg</option>
                                <option value="mg">mg</option>
                                <option value="IU">IU</option>
                            </select>
                        </div>

                        <div class="relative">
                            <svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            <select id="injection-site" required class="input-field">
                                <option value="" disabled selected>Site d'injection</option>
                                <optgroup label="Abdomen">
                                    <option value="Abdomen Droit (Haut)">Abdo Droit (Haut)</option>
                                    <option value="Abdomen Droit (Bas)">Abdo Droit (Bas)</option>
                                    <option value="Abdomen Gauche (Haut)">Abdo Gauche (Haut)</option>
                                    <option value="Abdomen Gauche (Bas)">Abdo Gauche (Bas)</option>
                                </optgroup>
                                <optgroup label="Flancs & Cuisses">
                                    <option value="Flanc Droit">Flanc Droit</option>
                                    <option value="Flanc Gauche">Flanc Gauche</option>
                                    <option value="Cuisse Droite">Cuisse Droite</option>
                                    <option value="Cuisse Gauche">Cuisse Gauche</option>
                                </optgroup>
                                <optgroup label="Bras & Autres">
                                    <option value="Delto√Øde Droit">Delto√Øde Droit</option>
                                    <option value="Delto√Øde Gauche">Delto√Øde Gauche</option>
                                    <option value="Spray Nasal">Spray Nasal</option>
                                    <option value="Other">Autre</option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <div id="custom-site-group" class="hidden">
                            <div class="relative">
                                <svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5" /></svg>
                                <input type="text" id="custom-site" placeholder="Nom du site..." class="input-field">
                            </div>
                        </div>

                        <div class="relative">
                            <svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <input type="datetime-local" id="timestamp" required class="input-field" style="color-scheme: dark;">
                        </div>

                        <button type="submit" id="submit-btn" class="btn-primary w-full text-lg">Enregistrer</button>
                    </form>
                </section>
            </div>

            <!-- HISTORY TAB -->
            <div id="view-history" class="hidden space-y-4">
                <div class="flex justify-between items-end px-2">
                    <h2 class="text-lg font-bold text-white">Historique</h2>
                    <span class="text-xs text-indigo-400 bg-indigo-500/10 px-2 py-1 rounded-lg">Derniers 50</span>
                </div>
                <div id="history-list" class="space-y-3"></div>
            </div>

            <!-- CALCULATOR TAB -->
            <div id="view-calculator" class="hidden space-y-6">
                <div class="card text-center py-8 bg-gradient-to-b from-gray-800 to-gray-900">
                    <p class="text-indigo-400 text-xs font-bold uppercase tracking-widest mb-2">√Ä pr√©lever</p>
                    <div class="text-6xl font-black text-white tracking-tighter" id="calculator-result">0 <span class="text-3xl text-gray-600">UI</span></div>
                    <p class="text-gray-500 mt-2 font-mono" id="calculator-microliters">(0 ¬µL)</p>
                </div>

                <form id="calculator-form" class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-400 ml-1 mb-1 block uppercase font-bold tracking-wide">Masse du Flacon</label>
                        <div class="flex">
                            <input type="number" id="vial-mass-input" placeholder="5" class="input-field rounded-r-none border-r-0 flex-1">
                            <select id="vial-mass-unit" class="unit-select"><option value="mg">mg</option><option value="mcg">mcg</option></select>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 ml-1 mb-1 block uppercase font-bold tracking-wide">Eau Bact√©riostatique</label>
                        <div class="flex">
                            <input type="number" id="dilution-volume-input" placeholder="2" class="input-field rounded-r-none border-r-0 flex-1">
                            <select id="dilution-volume-unit" class="unit-select"><option value="ml">mL</option></select>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 ml-1 mb-1 block uppercase font-bold tracking-wide">Dose Cible</label>
                        <div class="flex">
                            <input type="number" id="target-dose-input" placeholder="250" class="input-field rounded-r-none border-r-0 flex-1">
                            <select id="target-dose-unit" class="unit-select"><option value="mcg">mcg</option><option value="mg">mg</option></select>
                        </div>
                    </div>
                </form>
            </div>

            <!-- CONFIG TAB -->
            <div id="view-config" class="hidden space-y-6">
                <section class="card">
                    <h2 class="text-lg font-bold mb-4">Nouveau Raccourci</h2>
                    <form id="config-form" class="space-y-4">
                        <input type="text" id="config-label" placeholder="Titre (ex: GHK Matin)" class="input-field">
                        <input type="text" id="config-peptide" placeholder="Nom Peptide (ex: GHK-Cu)" class="input-field">
                        <div class="flex">
                            <input type="number" id="config-value" placeholder="Dose" class="input-field rounded-r-none border-r-0 flex-1">
                            <select id="config-unit" class="unit-select"><option value="mcg">mcg</option><option value="mg">mg</option><option value="IU">IU</option></select>
                        </div>
                        <button type="submit" id="config-submit-btn" class="btn-primary w-full">Cr√©er Raccourci</button>
                    </form>
                </section>
                <button id="reset-app-btn" class="w-full py-4 border border-red-900/50 text-red-400 rounded-xl hover:bg-red-900/20 transition text-sm font-bold">D√©connexion / Reset</button>
            </div>

        </main>
    </div>

    <!-- MODAL SITE SELECTION -->
    <div id="site-modal" class="fixed inset-0 z-50 bg-gray-950/80 backdrop-blur-sm hidden flex items-end sm:items-center justify-center p-4">
        <div class="modal-content w-full max-w-md bg-gray-900 border border-gray-800 shadow-2xl flex flex-col max-h-[80vh]">
            <div class="p-5 border-b border-gray-800 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white">Choisir le Site</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div id="modal-sites-list" class="p-4 overflow-y-auto grid grid-cols-1 gap-2"></div>
        </div>
    </div>

    <script>
        let APP_URL = localStorage.getItem('pep_log_url');
        const els = {
            setup: document.getElementById('setup-screen'), app: document.getElementById('app-container'),
            tabs: { log: document.getElementById('tab-log'), history: document.getElementById('tab-history'), calculator: document.getElementById('tab-calculator'), config: document.getElementById('tab-config') },
            views: { log: document.getElementById('view-log'), history: document.getElementById('view-history'), calculator: document.getElementById('view-calculator'), config: document.getElementById('view-config') },
            quickContainer: document.getElementById('quick-log-buttons'), historyList: document.getElementById('history-list'), streakContainer: document.getElementById('streak-container'),
            modal: document.getElementById('site-modal'), modalList: document.getElementById('modal-sites-list'),
            logForm: document.getElementById('log-form'), configForm: document.getElementById('config-form'),
            pep: document.getElementById('peptide-name'), custPep: document.getElementById('custom-peptide'), custPepGrp: document.getElementById('custom-peptide-group'),
            site: document.getElementById('injection-site'), custSite: document.getElementById('custom-site'), custSiteGrp: document.getElementById('custom-site-group'),
            calc: { m: document.getElementById('vial-mass-input'), mu: document.getElementById('vial-mass-unit'), v: document.getElementById('dilution-volume-input'), vu: document.getElementById('dilution-volume-unit'), d: document.getElementById('target-dose-input'), du: document.getElementById('target-dose-unit'), res: document.getElementById('calculator-result'), mic: document.getElementById('calculator-microliters') },
            suggestionBox: document.getElementById('suggestion-box'), suggestionText: document.getElementById('suggestion-text')
        };

        // Ordered Rotation List
        const sites = [ 
            {name: "Abdomen Droit (Haut)", icon: "AD"}, {name: "Abdomen Droit (Bas)", icon: "AD"}, 
            {name: "Abdomen Gauche (Haut)", icon: "AG"}, {name: "Abdomen Gauche (Bas)", icon: "AG"}, 
            {name: "Flanc Droit", icon: "FD"}, {name: "Flanc Gauche", icon: "FG"}, 
            {name: "Cuisse Droite", icon: "CD"}, {name: "Cuisse Gauche", icon: "CG"}, 
            {name: "Delto√Øde Droit", icon: "DD"}, {name: "Delto√Øde Gauche", icon: "DG"}
        ];
        // Sites excluded from rotation calculation but available in list
        const extraSites = [{name: "Spray Nasal", icon: "üëÉ"}, {name: "Autre", icon: "?"}];
        
        let pendingPreset = null;
        let currentSuggestion = null;

        function init() {
            const params = new URLSearchParams(window.location.search);
            const magic = params.get('db');
            if(magic && magic.startsWith('https')) { localStorage.setItem('pep_log_url', magic); APP_URL = magic; window.history.replaceState({}, '', window.location.pathname); }
            if(!APP_URL) { els.setup.classList.remove('hidden'); } else { els.app.classList.remove('hidden'); setupEvents(); loadConfig(); loadHistory(); }
        }

        document.getElementById('setup-form').addEventListener('submit', (e) => { e.preventDefault(); const url = document.getElementById('setup-url').value.trim(); if(url) { localStorage.setItem('pep_log_url', url); APP_URL = url; location.reload(); } });
        document.getElementById('reset-app-btn').addEventListener('click', () => { if(confirm("D√©connecter ?")) { localStorage.removeItem('pep_log_url'); location.reload(); } });
        document.getElementById('refresh-app').addEventListener('click', () => { loadConfig(); loadHistory(); });

        function setupEvents() {
            Object.keys(els.tabs).forEach(key => els.tabs[key].addEventListener('click', () => switchView(key)));
            els.pep.addEventListener('change', () => { const isOther = els.pep.value === 'Other'; els.custPepGrp.classList.toggle('hidden', !isOther); });
            els.site.addEventListener('change', () => { const isOther = els.site.value === 'Other'; els.custSiteGrp.classList.toggle('hidden', !isOther); });
            document.getElementById('timestamp').value = new Date(new Date() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0,16);
            els.logForm.addEventListener('submit', handleManualLog);
            els.configForm.addEventListener('submit', handleConfigSave);
            Object.values(els.calc).forEach(el => { if(el.tagName === 'INPUT' || el.tagName === 'SELECT') el.addEventListener('input', runCalc); });
            
            els.modalList.innerHTML = '';
            [...sites, ...extraSites].forEach(s => { 
                const btn = document.createElement('button'); 
                btn.className = "w-full p-4 bg-gray-800 border border-gray-700 rounded-xl text-left hover:bg-gray-700 transition flex items-center gap-3 mb-2"; 
                btn.innerHTML = `<span class="w-8 h-8 rounded-full bg-gray-900 flex items-center justify-center text-xs font-bold text-gray-400 border border-gray-700">${s.icon}</span> <span class="font-medium text-white">${s.name}</span>`; 
                btn.onclick = () => finalizeQuickLog(s.name); 
                els.modalList.appendChild(btn); 
            });
        }

        function switchView(view) {
            Object.values(els.tabs).forEach(t => { t.classList.remove('active'); });
            Object.values(els.views).forEach(v => v.classList.add('hidden'));
            els.views[view].classList.remove('hidden');
            els.tabs[view].classList.add('active');
            if(view === 'history') loadHistory();
        }

        async function api(data) { try { const res = await fetch(APP_URL, { method: 'POST', body: JSON.stringify(data) }); return await res.json(); } catch(e) { return { success: false, error: "Erreur connexion" }; } }

        async function loadConfig() {
            const res = await fetch(`${APP_URL}?action=getConfig`).then(r=>r.json()).catch(e=>({}));
            if(res.success && res.presets) {
                els.quickContainer.innerHTML = '';
                res.presets.forEach(p => {
                    const btn = document.createElement('button'); btn.className = "btn-quick bg-gray-800 border border-gray-700 rounded-xl p-4 hover:border-indigo-500 transition text-left group";
                    btn.innerHTML = `<div class="font-bold text-white group-hover:text-indigo-400">${p.label}</div><div class="text-xs text-gray-500 mt-1">${p.value}${p.unit}</div>`;
                    btn.onclick = () => { pendingPreset = p; els.modal.classList.remove('hidden'); };
                    els.quickContainer.appendChild(btn);
                });
            } else { els.quickContainer.innerHTML = `<div class="col-span-2 text-center p-4 border border-dashed border-gray-700 rounded-xl text-gray-600 text-sm">Aucun raccourci.</div>`; }
        }

        async function loadHistory() {
            els.historyList.innerHTML = '<div class="text-center p-4 animate-pulse text-gray-600">Chargement...</div>';
            const res = await fetch(`${APP_URL}?action=getHistory`).then(r=>r.json()).catch(e=>({}));
            if(res.success && res.history) {
                renderStreak(res.history);
                calculateSuggestion(res.history); // Calc suggestion here
                els.historyList.innerHTML = '';
                res.history.forEach(h => {
                    // ENGLISH DATE FORMATTING
                    let dateStr = h.date;
                    let timeStr = "";
                    const dateObj = new Date(h.date);
                    if (!isNaN(dateObj.getTime())) {
                        dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                        timeStr = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                    } 

                    const card = document.createElement('div'); 
                    card.className = "card flex justify-between items-center py-3 px-4";
                    card.innerHTML = `
                        <div>
                            <div class="font-bold text-white flex items-center gap-2">
                                ${h.peptide} 
                                <span class="text-xs bg-indigo-500/10 text-indigo-400 px-2 py-0.5 rounded font-mono">${h.dosage}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                                <span class="w-1.5 h-1.5 rounded-full bg-gray-600"></span> ${h.site}
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <div class="text-right text-xs text-gray-500 font-mono">
                                <div class="text-gray-400">${dateStr}</div>
                                <div>${timeStr}</div>
                            </div>
                            <button class="text-gray-600 hover:text-red-400 transition p-1" onclick="deleteEntry('${h.row}')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                            </button>
                        </div>`;
                    els.historyList.appendChild(card);
                });
            } else {
                els.historyList.innerHTML = '<div class="text-center text-gray-600 py-4">Aucun historique.</div>';
            }
        }

        // --- LOGIC SUGGESTION ---
        function calculateSuggestion(history) {
            if(!history || history.length === 0) {
                showSuggestion(sites[0].name); // Start with first
                return;
            }
            
            // Get last valid injection (exclude Nasal Spray/Other if needed, but for now take last)
            // History is ordered new -> old. history[0] is latest.
            const lastLog = history[0];
            const lastDateStr = lastLog.date; // Should be ISO
            
            // Parse Dates
            const lastDateObj = new Date(lastDateStr);
            const todayObj = new Date();
            
            // Compare Days (simple string comparison of YYYY-MM-DD)
            const isSameDay = lastDateObj.toISOString().split('T')[0] === todayObj.toISOString().split('T')[0];
            
            if(isSameDay) {
                // SAME DAY => Keep SAME Site
                showSuggestion(lastLog.site);
            } else {
                // NEW DAY => NEXT Site
                const lastSiteName = lastLog.site;
                const idx = sites.findIndex(s => s.name === lastSiteName);
                
                if (idx === -1) {
                    // Last site not in list (maybe custom), default to first
                    showSuggestion(sites[0].name);
                } else {
                    // Next one, loop back to 0
                    const nextIdx = (idx + 1) % sites.length;
                    showSuggestion(sites[nextIdx].name);
                }
            }
        }

        function showSuggestion(siteName) {
            currentSuggestion = siteName;
            els.suggestionText.textContent = siteName;
            els.suggestionBox.classList.remove('hidden');
        }

        function useSuggestion() {
            if(!currentSuggestion) return;
            // Fill manual form
            els.site.value = currentSuggestion;
            // Visual feedback
            els.site.focus();
            // Optional: You could auto-select in Quick Log modal if user opens it next
        }

        async function deleteEntry(rowId) {
            if(!confirm("Supprimer cette entr√©e ?")) return;
            const res = await api({ action: 'deleteLog', row: rowId });
            if(res.success) loadHistory();
        }

        function renderStreak(history) {
            const today = new Date();
            els.streakContainer.innerHTML = '';
            for(let i=6; i>=0; i--) {
                const d = new Date(today); d.setDate(today.getDate() - i);
                const dateStr = d.toISOString().split('T')[0]; 
                const hasLog = history.some(h => {
                    if(!h.date) return false;
                    return h.date.startsWith(dateStr); 
                });
                const circle = document.createElement('div');
                circle.className = `w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border ${hasLog ? 'bg-green-900/30 border-green-500/50 text-green-400' : 'bg-gray-800 border-gray-700 text-gray-600'}`;
                circle.textContent = d.getDate();
                els.streakContainer.appendChild(circle);
            }
        }

        async function handleManualLog(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-btn'); const originalText = btn.innerHTML; btn.innerHTML = "Sauvegarde..."; btn.disabled = true;
            const pName = els.pep.value === 'Other' ? document.getElementById('custom-peptide').value : els.pep.value;
            const sName = els.site.value === 'Other' ? document.getElementById('custom-site').value : els.site.value;
            const dose = `${document.getElementById('dosage-value').value} ${document.getElementById('dosage-unit').value}`;
            const data = { action: 'logInjection', peptide: pName, dosage: dose, site: sName, timestamp: document.getElementById('timestamp').value };
            const res = await api(data);
            btn.innerHTML = originalText; btn.disabled = false;
            if(res.success) { alert("Sauvegard√© !"); els.logForm.reset(); document.getElementById('timestamp').value = new Date(new Date() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0,16); loadHistory(); }
        }

        async function finalizeQuickLog(site) {
            els.modal.classList.add('hidden');
            if(!pendingPreset) return;
            const data = { action: 'logInjection', peptide: pendingPreset.peptide, dosage: `${pendingPreset.value} ${pendingPreset.unit}`, site: site, timestamp: new Date().toISOString() };
            const res = await api(data);
            if(res.success) { alert(`Sauvegard√© : ${pendingPreset.peptide}`); loadHistory(); }
            pendingPreset = null;
        }

        async function handleConfigSave(e) {
            e.preventDefault();
            const btn = document.getElementById('config-submit-btn'); btn.textContent = "Sauvegarde..."; btn.disabled = true;
            const data = { action: 'saveConfig', label: document.getElementById('config-label').value, peptide: document.getElementById('config-peptide').value, value: document.getElementById('config-value').value, unit: document.getElementById('config-unit').value, site: 'Ask' };
            const res = await api(data);
            btn.textContent = "Cr√©er Raccourci"; btn.disabled = false;
            if(res.success) { alert("Raccourci cr√©√© !"); loadConfig(); switchView('log'); }
        }

        function runCalc() {
            const vm = parseFloat(els.calc.m.value), dv = parseFloat(els.calc.v.value), td = parseFloat(els.calc.d.value);
            if(!vm || !dv || !td) { els.calc.res.innerText = "0 UI"; els.calc.mic.innerText = "(0 ¬µL)"; return; }
            const m_ug = els.calc.mu.value === 'mg' ? vm * 1000 : vm;
            const d_ug = els.calc.du.value === 'mg' ? td * 1000 : td;
            const vol = (d_ug / (m_ug / dv));
            els.calc.res.innerText = `${(vol * 100).toFixed(1)} UI`; els.calc.mic.innerText = `(${vol.toFixed(2) * 1000} ¬µL)`;
        }

        function closeModal() { els.modal.classList.add('hidden'); }
        init(); switchView('log');
    </script>
</body>
</html>
