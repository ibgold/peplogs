<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Peptide Log</title>
    
    <!-- PWA Config -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%236366f1'/><path d='M50 20v40m0 0l-15-15m15 15l15-15' stroke='white' stroke-width='8' stroke-linecap='round'/><circle cx='50' cy='75' r='10' fill='white'/></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%230f172a'/><rect x='20' y='20' width='60' height='60' rx='15' fill='%236366f1'/><path d='M50 35v30M35 50h30' stroke='white' stroke-width='8' stroke-linecap='round'/></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: { background: '#0f172a', surface: '#1e293b', primary: '#6366f1' },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'slide-up': 'slideUp 0.4s ease-out', 'pulse-slow': 'pulse 3s infinite' },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }, slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } } }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%); color: #f8fafc; -webkit-tap-highlight-color: transparent; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        .suggestion-glass { background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(30, 41, 59, 0.7) 100%); border: 1px solid rgba(99, 102, 241, 0.3); box-shadow: 0 0 20px rgba(99, 102, 241, 0.1); }
        
        .input-group { position: relative; transition: all 0.3s ease; }
        .input-field { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.2); color: white; border-radius: 1rem; padding: 0.75rem 1rem 0.75rem 2.5rem; width: 100%; font-size: 16px; transition: all 0.2s; }
        .input-field:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); outline: none; background: rgba(15, 23, 42, 0.9); }
        .input-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; }
        
        select.input-field { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3c/svg%3e"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
        select.input-field option { background-color: #1e293b; color: #f8fafc; padding: 10px; }
        select.input-field optgroup { background-color: #0f172a; color: #94a3b8; font-weight: bold; }

        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); transition: transform 0.2s, box-shadow 0.2s; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-quick { background: rgba(51, 65, 85, 0.5); border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; position: relative; overflow: hidden; }
        .btn-quick:active { background: rgba(99, 102, 241, 0.2); border-color: #6366f1; }

        .nav-pill { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .nav-pill.active { background: #6366f1; color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }

        /* Syringe Visual Styles */
        .syringe-container {
            position: relative;
            width: 60px;
            height: 300px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border: 2px solid #475569;
            overflow: hidden;
        }
        .syringe-marks {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            padding: 10px 0; 
            pointer-events: none;
            z-index: 10;
        }
        .mark {
            position: absolute;
            left: 0;
            width: 50%;
            height: 1px;
            border-top: 1px solid rgba(255,255,255,0.3);
            transform: translateY(-0.5px); 
        }
        .mark.major {
            width: 100%;
            border-top: 1px solid rgba(255,255,255,0.8);
        }
        .mark-label {
            position: absolute;
            right: 45px; 
            top: -6px;
            font-size: 10px;
            color: #94a3b8;
            font-family: monospace;
        }
        .liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, #ef4444, #f87171); 
            transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.8;
            z-index: 1;
        }
        .plunger {
            position: absolute;
            bottom: 0; 
            left: 0;
            width: 100%;
            height: 10px;
            background: #334155;
            z-index: 2;
            transition: bottom 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-top: 2px solid #cbd5e1;
        }
        .needle {
            width: 2px;
            height: 20px;
            background: #cbd5e1;
            margin: 0 auto 2px auto;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen pb-6">

    <!-- SETUP OVERLAY -->
    <div id="setup-screen" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-6 hidden">
        <div class="glass-card w-full max-w-md p-8 rounded-2xl text-center space-y-6">
            <div class="w-16 h-16 bg-indigo-500/20 rounded-full flex items-center justify-center mx-auto text-indigo-400 animate-bounce">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
            </div>
            <h2 class="text-2xl font-bold">Connect Database</h2>
            <p class="text-slate-400">Paste your Google Apps Script URL to start.</p>
            <form id="setup-form" class="space-y-4">
                <div class="input-group">
                    <svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                    <input type="url" id="setup-url" required placeholder="https://script.google.com/..." class="input-field">
                </div>
                <button type="submit" class="btn-primary w-full py-3.5 rounded-xl font-bold text-lg">Connect</button>
            </form>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="w-full max-w-lg flex flex-col h-full hidden animate-fade-in">
        
        <header class="pt-6 pb-2 px-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-white">Peptide Log</h1>
                <p id="status-text" class="text-xs text-slate-400 flex items-center gap-1 transition-all duration-300">
                    <span id="status-dot" class="w-2 h-2 rounded-full bg-green-500"></span> <span id="status-label">Ready</span>
                </p>
            </div>
            <div class="flex gap-2">
                <div id="pending-badge" class="hidden bg-amber-500/20 text-amber-400 border border-amber-500/30 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 animate-pulse-slow">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M18 12h4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 18v4"/><path d="m4.9 19.1 2.9-2.9"/><path d="M2 12h4"/><path d="m4.9 4.9 2.9 2.9"/></svg>
                    <span id="pending-count">0</span>
                </div>
                <button id="refresh-app" class="p-2 bg-slate-800 rounded-full text-slate-400 hover:text-white active:scale-90 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
                </button>
            </div>
        </header>

        <nav class="px-4 py-2">
            <div class="flex bg-slate-800/50 p-1 rounded-2xl backdrop-blur-sm border border-slate-700/50">
                <button id="tab-log" class="nav-pill flex-1 py-2.5 rounded-xl text-sm font-medium text-slate-400 flex justify-center items-center gap-2 active" onclick="switchTab('log')">Log</button>
                <button id="tab-history" class="nav-pill flex-1 py-2.5 rounded-xl text-sm font-medium text-slate-400 flex justify-center items-center gap-2" onclick="switchTab('history')">History</button>
                <button id="tab-calculator" class="nav-pill flex-1 py-2.5 rounded-xl text-sm font-medium text-slate-400 flex justify-center items-center gap-2" onclick="switchTab('calculator')">Visual Calc</button>
                <button id="tab-config" class="nav-pill flex-1 py-2.5 rounded-xl text-sm font-medium text-slate-400 flex justify-center items-center gap-2" onclick="switchTab('config')">Config</button>
            </div>
        </nav>

        <main class="flex-1 px-4 py-4 overflow-y-auto custom-scrollbar" id="main-content">
            
            <!-- LOG TAB -->
            <div id="view-log" class="space-y-6 animate-slide-up">
                
                <div id="suggestion-box" class="suggestion-glass glass-card p-4 rounded-2xl flex justify-between items-center hidden relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                    <div class="pl-2 relative z-10">
                        <p class="text-indigo-300 text-xs font-bold uppercase tracking-wider mb-1 flex items-center gap-1">Suggested Rotation</p>
                        <p id="suggestion-text" class="text-white font-bold text-lg tracking-tight">Loading...</p>
                    </div>
                    <button onclick="useSuggestion()" class="bg-indigo-600/90 hover:bg-indigo-500 text-white text-xs font-bold py-2 px-4 rounded-lg transition shadow-lg shadow-indigo-500/30 backdrop-blur-sm">Use</button>
                </div>

                <div class="glass-card rounded-2xl p-4 flex justify-between items-center">
                    <span class="text-xs font-bold text-indigo-300 uppercase tracking-wider">7 Day Streak</span>
                    <div id="streak-container" class="flex gap-2">
                        <div class="w-8 h-8 rounded-full bg-slate-700 animate-pulse"></div>
                    </div>
                </div>

                <section>
                    <h2 class="text-sm font-bold text-indigo-300 uppercase tracking-wider mb-3 ml-1">Quick Log</h2>
                    <div id="quick-log-buttons" class="grid grid-cols-2 gap-3">
                        <div class="col-span-2 bg-slate-800/50 rounded-xl p-6 text-center border border-dashed border-slate-700">
                            <p class="text-slate-500 text-sm">Loading presets...</p>
                        </div>
                    </div>
                </section>

                <section class="glass-card rounded-3xl p-6">
                    <h2 class="text-sm font-bold text-indigo-300 uppercase tracking-wider mb-4">Manual Entry</h2>
                    <form id="log-form" class="space-y-4">
                        <div class="input-group">
                            <svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                            <select id="peptide-name" required class="input-field">
                                <option value="" disabled selected>Select Peptide</option>
                                <option value="Tirzepatide">Tirzepatide</option>
                                <option value="BPC 157">BPC 157</option>
                                <option value="CJC-1295 + Ipamorelin">CJC-1295 + Ipamorelin</option>
                                <option value="GHK-Cu">GHK-Cu</option>
                                <option value="Semax">Semax</option>
                                <option value="Selank">Selank</option>
                                <option value="Other">Other (Custom)</option>
                            </select>
                        </div>
                        <div id="custom-peptide-group" class="hidden animate-fade-in">
                            <input type="text" id="custom-peptide" placeholder="Type Peptide Name..." class="input-field pl-4">
                        </div>
                        <div class="flex gap-2">
                            <div class="input-group flex-1">
                                <svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4" /></svg>
                                <input type="number" id="dosage-value" min="0.01" step="0.01" placeholder="Dose" class="input-field">
                            </div>
                            <select id="dosage-unit" class="bg-slate-700 text-white rounded-xl px-3 border border-slate-600 focus:border-indigo-500 outline-none font-bold w-24">
                                <option value="mcg">mcg</option>
                                <option value="mg">mg</option>
                                <option value="IU">IU</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            <select id="injection-site" required class="input-field">
                                <option value="" disabled selected>Select Site</option>
                                <optgroup label="Abdomen">
                                    <option value="Right Abdomen (Upper)">Right Abdomen (Upper)</option>
                                    <option value="Right Abdomen (Lower)">Right Abdomen (Lower)</option>
                                    <option value="Left Abdomen (Upper)">Left Abdomen (Upper)</option>
                                    <option value="Left Abdomen (Lower)">Left Abdomen (Lower)</option>
                                </optgroup>
                                <optgroup label="Flanks & Thighs">
                                    <option value="Right Flank">Right Flank</option>
                                    <option value="Left Flank">Left Flank</option>
                                    <option value="Right Thigh">Right Thigh</option>
                                    <option value="Left Thigh">Left Thigh</option>
                                </optgroup>
                                <optgroup label="Arms & Other">
                                    <option value="Right Deltoid">Right Deltoid</option>
                                    <option value="Left Deltoid">Left Deltoid</option>
                                    <option value="Nasal Spray">Nasal Spray</option>
                                    <option value="Other">Other</option>
                                </optgroup>
                            </select>
                        </div>
                        <div id="custom-site-group" class="hidden animate-fade-in">
                            <input type="text" id="custom-site" placeholder="Site Name" class="input-field pl-4">
                        </div>
                        <div class="input-group">
                            <svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            <input type="text" id="manual-notes" placeholder="Notes (optional)..." class="input-field">
                        </div>
                        <div class="input-group">
                            <svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <input type="datetime-local" id="timestamp" required class="input-field" style="color-scheme: dark;">
                        </div>
                        <button type="submit" id="submit-btn" class="btn-primary w-full py-4 rounded-2xl font-bold text-lg shadow-lg shadow-indigo-500/20 mt-2">Log Injection</button>
                        <p id="response-message" class="text-center text-sm font-medium hidden mt-2"></p>
                    </form>
                </section>
            </div>

            <!-- HISTORY TAB -->
            <div id="view-history" class="hidden space-y-4 animate-slide-up">
                <div class="flex flex-col gap-4">
                    <div class="flex justify-between items-end px-2">
                        <h2 class="text-xl font-bold text-white">History</h2>
                        <span class="text-xs text-indigo-400 bg-indigo-500/10 px-2 py-1 rounded-lg">Last 50</span>
                    </div>
                    <div class="input-group">
                        <svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                        <input type="text" id="history-search" placeholder="Filter..." class="input-field pl-10 bg-slate-800/50 border-slate-700/50 focus:bg-slate-800">
                    </div>
                </div>
                <div id="history-list" class="space-y-3 pb-20">
                    <div class="p-8 text-center text-slate-500">Loading...</div>
                </div>
            </div>

            <!-- CALCULATOR TAB -->
            <div id="view-calculator" class="hidden space-y-6 animate-slide-up">
                <div class="glass-card rounded-3xl p-6 text-center flex flex-col items-center">
                    <div class="needle"></div>
                    <div class="syringe-container mb-4">
                         <div class="syringe-marks" id="syringe-marks">
                             <!-- Generated by JS -->
                         </div>
                         <div class="liquid" id="visual-liquid" style="height: 0%;"></div>
                         <div class="plunger" id="visual-plunger" style="bottom: 0%;"></div>
                    </div>

                    <p class="text-indigo-300 text-sm font-semibold uppercase tracking-wider mb-1">Draw to (Tick Mark)</p>
                    <div class="text-6xl font-black text-white tracking-tighter drop-shadow-md flex items-end justify-center gap-2">
                        <span id="calculator-result">0</span> <span class="text-2xl text-slate-500 mb-2">IU</span>
                    </div>
                    
                    <div class="mt-4 w-full pt-4 border-t border-slate-700 space-y-3">
                         <!-- Concentration Panel (New) -->
                        <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700 text-sm">
                            <p class="text-xs text-slate-400 mb-1">Total Reconstitution Concentration</p>
                            <div id="calc-conc-panel" class="font-bold text-white flex justify-between items-center">
                                <span id="calc-concentration" class="text-xl">--</span> mcg/mL
                                <div id="calc-alert" class="hidden text-red-400 bg-red-900/30 px-2 py-0.5 rounded-full text-xs font-bold border border-red-500/50">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-1"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    High Conc.
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between text-xs text-slate-400">
                            <div class="text-center w-1/2">
                                <div class="text-white font-bold" id="calc-mcg-unit">0</div>
                                <div>mcg per Unit (IU)</div>
                            </div>
                            <div class="text-center w-1/2">
                                <div class="text-white font-bold" id="calculator-microliters">0</div>
                                <div>ÂµL Volume</div>
                            </div>
                        </div>
                    </div>
                </div>

                <form id="calculator-form" class="space-y-4">
                    <div>
                        <label class="text-sm text-slate-400 ml-1">Vial Mass</label>
                        <div class="flex gap-2">
                            <input type="number" id="vial-mass-input" placeholder="5" class="input-field flex-1">
                            <select id="vial-mass-unit" class="bg-slate-700 text-white rounded-xl px-3 font-bold w-20"><option value="mg">mg</option><option value="mcg">mcg</option></select>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-slate-400 ml-1">Bac Water (Reconstitution)</label>
                        <div class="flex gap-2">
                            <input type="number" id="dilution-volume-input" placeholder="2" class="input-field flex-1">
                            <select id="dilution-volume-unit" class="bg-slate-700 text-white rounded-xl px-3 font-bold w-20"><option value="ml">mL</option></select>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-slate-400 ml-1">Target Dose</label>
                        <div class="flex gap-2">
                            <input type="number" id="target-dose-input" placeholder="250" class="input-field flex-1">
                            <select id="target-dose-unit" class="bg-slate-700 text-white rounded-xl px-3 font-bold w-20"><option value="mcg">mcg</option><option value="mg">mg</option></select>
                        </div>
                    </div>
                </form>
            </div>

            <!-- CONFIG TAB -->
            <div id="view-config" class="hidden space-y-6 animate-slide-up">
                <section class="glass-card rounded-3xl p-6">
                    <h2 class="text-xl font-bold mb-4">Add Quick Log</h2>
                    <form id="config-form" class="space-y-4">
                        <div class="flex items-center justify-between bg-slate-800/50 p-3 rounded-xl border border-slate-700/50"><span class="text-sm font-medium text-gray-300">Track Cycle?</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="cycle-toggle" class="sr-only peer"><div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div></label></div>
                        <input type="text" id="config-label" placeholder="Label (e.g. Daily GHK)" class="input-field">
                        <input type="text" id="config-peptide" placeholder="Peptide Name (e.g. GHK-Cu)" class="input-field">
                        <div class="flex gap-2"><input type="number" id="config-value" placeholder="Dose" class="input-field flex-1"><select id="config-unit" class="bg-slate-700 text-white rounded-xl px-3 font-bold w-24"><option value="mcg">mcg</option><option value="mg">mg</option><option value="IU">IU</option></select></div>
                        <div id="cycle-options" class="hidden space-y-4 pt-2 border-t border-slate-700 mt-2">
                            <p class="text-xs text-indigo-400 font-bold uppercase tracking-wide">Cycle Settings</p>
                            <div><label class="text-xs text-slate-400">Start Date</label><div class="input-group"><svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><input type="date" id="config-cycle-start" class="input-field" style="color-scheme: dark;"></div></div>
                            <div><label class="text-xs text-slate-400">Duration (Weeks)</label><div class="input-group"><svg class="input-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><input type="number" id="config-cycle-weeks" placeholder="8" class="input-field"></div></div>
                            <div class="flex gap-2">
                                <div class="w-1/2">
                                    <label class="text-xs text-slate-400">ON Days</label>
                                    <input type="number" id="config-cycle-on" placeholder="5" class="input-field pl-4">
                                </div>
                                <div class="w-1/2">
                                    <label class="text-xs text-slate-400">OFF Days</label>
                                    <input type="number" id="config-cycle-off" placeholder="2" class="input-field pl-4">
                                </div>
                            </div>
                        </div>
                        <button type="submit" id="config-submit-btn" class="btn-primary w-full py-3 rounded-xl font-bold">Save Preset</button>
                    </form>
                </section>
                <button id="reset-app-btn" class="w-full py-4 border border-red-500/30 text-red-400 rounded-2xl hover:bg-red-500/10 transition">Disconnect / Reset</button>
            </div>
        </main>
    </div>

    <!-- MODAL FOR SITE SELECTION -->
    <div id="site-modal" class="fixed inset-0 z-50 bg-slate-900/80 backdrop-blur-sm hidden flex items-end sm:items-center justify-center p-4 animate-fade-in">
        <div class="bg-slate-800 w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl border-t border-slate-700 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Select Site</h3><button onclick="closeModal()" class="p-2 bg-slate-700 rounded-full text-slate-300 hover:text-white">&times;</button></div>
            <div class="mb-4 relative"><svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg><input type="text" id="modal-note" placeholder="Add optional note..." class="w-full bg-slate-900 border border-slate-700 rounded-xl py-3 px-4 pl-10 text-white focus:border-indigo-500 outline-none"></div>
            <div id="modal-sites-list" class="grid grid-cols-2 gap-3 overflow-y-auto pb-4"></div>
        </div>
    </div>

    <script>
        let APP_URL = localStorage.getItem('pep_log_url');
        let globalHistory = [];
        const els = {
            setup: document.getElementById('setup-screen'), app: document.getElementById('app-container'),
            statusDot: document.getElementById('status-dot'), statusLabel: document.getElementById('status-label'), pendingBadge: document.getElementById('pending-badge'), pendingCount: document.getElementById('pending-count'),
            tabs: { log: document.getElementById('tab-log'), history: document.getElementById('tab-history'), calculator: document.getElementById('tab-calculator'), config: document.getElementById('tab-config') },
            views: { log: document.getElementById('view-log'), history: document.getElementById('view-history'), calculator: document.getElementById('view-calculator'), config: document.getElementById('view-config') },
            quickContainer: document.getElementById('quick-log-buttons'), historyList: document.getElementById('history-list'), historySearch: document.getElementById('history-search'), streakContainer: document.getElementById('streak-container'),
            modal: document.getElementById('site-modal'), modalList: document.getElementById('modal-sites-list'), modalNote: document.getElementById('modal-note'),
            logForm: document.getElementById('log-form'), configForm: document.getElementById('config-form'),
            pep: document.getElementById('peptide-name'), custPep: document.getElementById('custom-peptide'), custPepGrp: document.getElementById('custom-peptide-group'),
            site: document.getElementById('injection-site'), custSite: document.getElementById('custom-site'), custSiteGrp: document.getElementById('custom-site-group'), manualNote: document.getElementById('manual-notes'),
            calc: { m: document.getElementById('vial-mass-input'), mu: document.getElementById('vial-mass-unit'), v: document.getElementById('dilution-volume-input'), vu: document.getElementById('dilution-volume-unit'), d: document.getElementById('target-dose-input'), du: document.getElementById('target-dose-unit'), res: document.getElementById('calculator-result'), mic: document.getElementById('calculator-microliters'), conc: document.getElementById('calc-concentration'), mcgPerUnit: document.getElementById('calc-mcg-unit'), syringeMarks: document.getElementById('syringe-marks'), visualLiquid: document.getElementById('visual-liquid'), visualPlunger: document.getElementById('visual-plunger'), alert: document.getElementById('calc-alert') },
            suggestionBox: document.getElementById('suggestion-box'), suggestionText: document.getElementById('suggestion-text'),
            cycleToggle: document.getElementById('cycle-toggle'), cycleOptions: document.getElementById('cycle-options'), cycleStart: document.getElementById('config-cycle-start'), cycleWeeks: document.getElementById('config-cycle-weeks'), cycleOn: document.getElementById('config-cycle-on'), cycleOff: document.getElementById('config-cycle-off')
        };

        const sites = [ {name: "Right Abdomen (Upper)", icon: "R"}, {name: "Right Abdomen (Lower)", icon: "R"}, {name: "Left Abdomen (Upper)", icon: "L"}, {name: "Left Abdomen (Lower)", icon: "L"}, {name: "Right Flank", icon: "R"}, {name: "Left Flank", icon: "L"}, {name: "Right Thigh", icon: "R"}, {name: "Left Thigh", icon: "L"}, {name: "Right Deltoid", icon: "R"}, {name: "Left Deltoid", icon: "L"} ];
        const extraSites = [{name: "Nasal Spray", icon: "ðŸ‘ƒ"}, {name: "Other", icon: "?"}];
        let pendingPreset = null, currentSuggestion = null;

        // OFFLINE QUEUE
        function getQueue() { return JSON.parse(localStorage.getItem('pep_log_queue') || '[]'); }
        function saveQueue(q) { localStorage.setItem('pep_log_queue', JSON.stringify(q)); updateNetworkUI(); }
        function addToQueue(data) { const q = getQueue(); q.push(data); saveQueue(q); }
        function updateNetworkUI() {
            const q = getQueue();
            if (!navigator.onLine) { els.statusDot.className = "w-2 h-2 rounded-full bg-amber-500"; els.statusLabel.innerText = "Offline"; els.statusLabel.className = "text-amber-500 font-bold"; }
            else if (q.length > 0) { els.statusDot.className = "w-2 h-2 rounded-full bg-blue-500 animate-pulse"; els.statusLabel.innerText = "Syncing..."; els.statusLabel.className = "text-blue-400 font-bold"; syncQueue(); }
            else { els.statusDot.className = "w-2 h-2 rounded-full bg-green-500"; els.statusLabel.innerText = "Ready"; els.statusLabel.className = "text-slate-400"; }
            if (q.length > 0) { els.pendingBadge.classList.remove('hidden'); els.pendingCount.innerText = q.length; } else { els.pendingBadge.classList.add('hidden'); }
        }
        async function syncQueue() {
            if (!navigator.onLine) return;
            const q = getQueue(); if (q.length === 0) return;
            const newQueue = [];
            for (const item of q) { try { const res = await fetch(APP_URL, { method: 'POST', body: JSON.stringify(item) }); const json = await res.json(); if (!json.success) newQueue.push(item); } catch (e) { newQueue.push(item); } }
            localStorage.setItem('pep_log_queue', JSON.stringify(newQueue)); updateNetworkUI(); if (newQueue.length === 0) loadHistory();
        }
        window.addEventListener('online', updateNetworkUI); window.addEventListener('offline', updateNetworkUI);

        function init() {
            const params = new URLSearchParams(window.location.search); const magic = params.get('db');
            if(magic && magic.startsWith('https')) { localStorage.setItem('pep_log_url', magic); APP_URL = magic; window.history.replaceState({}, '', window.location.pathname); }
            if(!APP_URL) { els.setup.classList.remove('hidden'); } else { els.app.classList.remove('hidden'); setupEvents(); loadConfig(); loadHistory(); updateNetworkUI(); initSyringe(); }
        }

        document.getElementById('setup-form').addEventListener('submit', (e) => { e.preventDefault(); const url = document.getElementById('setup-url').value.trim(); if(url) { localStorage.setItem('pep_log_url', url); APP_URL = url; location.reload(); } });
        document.getElementById('reset-app-btn').addEventListener('click', () => { if(confirm("Disconnect?")) { localStorage.removeItem('pep_log_url'); location.reload(); } });
        document.getElementById('refresh-app').addEventListener('click', () => { loadConfig(); loadHistory(); });

        function setupEvents() {
            Object.keys(els.tabs).forEach(key => els.tabs[key].addEventListener('click', () => switchView(key)));
            els.pep.addEventListener('change', () => { const isOther = els.pep.value === 'Other'; els.custPepGrp.classList.toggle('hidden', !isOther); if(isOther) document.getElementById('custom-peptide').focus(); });
            els.site.addEventListener('change', () => { const isOther = els.site.value === 'Other'; els.custSiteGrp.classList.toggle('hidden', !isOther); if(isOther) document.getElementById('custom-site').focus(); });
            els.cycleToggle.addEventListener('change', (e) => { if(e.target.checked) { els.cycleOptions.classList.remove('hidden'); els.cycleStart.value = new Date().toISOString().split('T')[0]; } else { els.cycleOptions.classList.add('hidden'); } });
            document.getElementById('timestamp').value = new Date(new Date() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0,16);
            els.logForm.addEventListener('submit', handleManualLog);
            els.configForm.addEventListener('submit', handleConfigSave);
            els.historySearch.addEventListener('input', filterHistory);
            Object.values(els.calc).forEach(el => { if(el.tagName === 'INPUT' || el.tagName === 'SELECT') el.addEventListener('input', runCalc); });
            els.modalList.innerHTML = '';
            [...sites, ...extraSites].forEach(s => {
                const btn = document.createElement('button'); btn.dataset.site = s.name;
                btn.className = "w-full p-4 bg-slate-800/50 hover:bg-indigo-600/80 rounded-xl text-left transition flex items-center gap-3 border border-slate-700/50";
                btn.innerHTML = `<span class="w-8 h-8 rounded-full bg-slate-900 flex items-center justify-center text-xs font-bold text-slate-400 border border-slate-700">${s.icon}</span> <span class="font-medium text-white">${s.name}</span>`;
                btn.onclick = () => finalizeQuickLog(s.name); els.modalList.appendChild(btn);
            });
        }

        function switchView(view) {
            Object.values(els.tabs).forEach(t => { t.classList.remove('bg-indigo-500', 'text-white', 'active'); t.classList.add('text-slate-400'); t.style.background = 'transparent'; t.style.color = '#94a3b8'; });
            Object.values(els.views).forEach(v => v.classList.add('hidden'));
            els.views[view].classList.remove('hidden'); els.tabs[view].classList.add('active'); els.tabs[view].style.background = '#6366f1'; els.tabs[view].style.color = 'white';
            if(view === 'history') loadHistory();
        }

        async function api(data) {
            if (!navigator.onLine) { addToQueue(data); return { success: true, offline: true }; }
            try { const res = await fetch(APP_URL, { method: 'POST', body: JSON.stringify(data) }); return await res.json(); } catch(e) { addToQueue(data); return { success: true, offline: true }; }
        }

        // --- CYCLE LOGIC ---
        function getCycleState(p, dateToCheck) {
            if (!p.cycleStart || !p.cycleWeeks || !p.cycleON || !p.cycleOFF) return { state: 'N/A', display: '' };
            const start = new Date(p.cycleStart);
            const checkDate = dateToCheck ? new Date(dateToCheck) : new Date();
            
            // Normalize dates to midnight to ensure accurate day comparison
            const startDay = new Date(start.getFullYear(), start.getMonth(), start.getDate());
            const checkDay = new Date(checkDate.getFullYear(), checkDate.getMonth(), checkDate.getDate());

            const diffTime = checkDay.getTime() - startDay.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return { state: 'STARTING', display: 'Starts Soon' };

            const totalCycleDays = (parseInt(p.cycleON) + parseInt(p.cycleOFF));
            const totalWeeks = parseInt(p.cycleWeeks);
            const currentWeek = Math.floor(diffDays / 7) + 1;

            if (currentWeek > totalWeeks) {
                return { state: 'OFF_CYCLE', display: 'Cycle Ended' };
            }

            const dayInCyclePattern = diffDays % totalCycleDays;
            
            if (dayInCyclePattern < parseInt(p.cycleON)) {
                return { state: 'ON', display: `Day ${dayInCyclePattern + 1} of ${p.cycleON} ON` };
            } else {
                return { state: 'OFF', display: `Day ${dayInCyclePattern - p.cycleON + 1} of ${p.cycleOFF} OFF` };
            }
        }
        
        function getCycleProgress(p) {
            if (!p.cycleStart || !p.cycleWeeks) return null; 
            const start = new Date(p.cycleStart), now = new Date();
            const diff = Math.ceil(Math.abs(now - start)/(1000*60*60*24));
            return { current: Math.ceil(diff/7), total: p.cycleWeeks, percent: Math.min(100, (Math.ceil(diff/7)/p.cycleWeeks)*100) }; 
        }

        async function loadConfig() {
            if (!navigator.onLine) { els.quickContainer.innerHTML = `<div class="col-span-2 text-center p-4 border border-dashed border-slate-700/50 rounded-xl text-slate-500 text-sm">Offline mode.</div>`; return; }
            const res = await fetch(`${APP_URL}?action=getConfig`).then(r=>r.json()).catch(e=>({}));
            if(res.success && res.presets) {
                els.quickContainer.innerHTML = '';
                res.presets.forEach(p => {
                    const cycleState = getCycleState(p);
                    let cycleHtml = '';
                    let btnClass = "btn-quick bg-slate-800/50 border border-slate-700/50 rounded-xl p-4 hover:border-indigo-500/50 transition text-left group relative overflow-hidden";
                    
                    if(cycleState.state !== 'N/A') {
                        const progress = getCycleProgress(p);
                        if(cycleState.state === 'OFF' || cycleState.state === 'OFF_CYCLE') {
                            btnClass = "bg-red-900/40 border-red-700/50 p-4 rounded-xl text-left transition group relative overflow-hidden hover:border-red-500/50";
                            cycleHtml = `<div class="w-full bg-slate-700 rounded-full h-1.5 mt-3 mb-1"><div class="bg-red-500 h-1.5 rounded-full" style="width: ${progress.percent}%"></div></div><div class="text-[10px] text-red-300 font-bold text-right">${cycleState.display}</div>`;
                        } else if (cycleState.state === 'ON') {
                            cycleHtml = `<div class="w-full bg-slate-700 rounded-full h-1.5 mt-3 mb-1"><div class="bg-green-500 h-1.5 rounded-full" style="width: ${progress.percent}%"></div></div><div class="text-[10px] text-green-300 font-bold text-right">Week ${progress.current} / ${progress.total}</div>`;
                        }
                    }

                    const btn = document.createElement('button');
                    btn.className = btnClass;
                    
                    btn.innerHTML = `<div class="font-bold text-white group-hover:text-indigo-400 mb-1">${p.label}</div><div class="text-xs text-slate-500">${p.value}${p.unit}</div>${cycleHtml}`;
                    
                    if (cycleState.state === 'OFF' || cycleState.state === 'OFF_CYCLE') {
                        btn.onclick = () => alert(`Cannot log: This is currently an ${cycleState.state === 'OFF' ? 'OFF day' : 'OFF-Cycle period'}.`);
                    } else {
                        btn.onclick = () => { pendingPreset = p; openSiteModal(); };
                    }
                    
                    els.quickContainer.appendChild(btn);
                });
            } else { els.quickContainer.innerHTML = `<div class="col-span-2 text-center p-4 border border-dashed border-slate-700/50 rounded-xl text-slate-500 text-sm">No presets found.</div>`; }
        }

        async function loadHistory() {
            if (!navigator.onLine) { els.historyList.innerHTML = '<div class="text-center text-slate-500 py-4">Offline mode.</div>'; return; }
            els.historyList.innerHTML = '<div class="text-center p-4 animate-pulse text-slate-500">Loading...</div>';
            const res = await fetch(`${APP_URL}?action=getHistory`).then(r=>r.json()).catch(e=>({}));
            if(res.success && res.history) { globalHistory = res.history; renderStreak(globalHistory); calculateSuggestion(globalHistory); renderHistoryList(globalHistory); } 
            else { els.historyList.innerHTML = '<div class="text-center text-slate-500">No logs found.</div>'; globalHistory = []; }
        }
        
        function filterHistory() {
            const term = els.historySearch.value.toLowerCase();
            const filtered = globalHistory.filter(h => (h.peptide && h.peptide.toLowerCase().includes(term)) || (h.site && h.site.toLowerCase().includes(term)) || (h.notes && h.notes.toLowerCase().includes(term)));
            renderHistoryList(filtered);
        }

        function renderHistoryList(list) {
            els.historyList.innerHTML = '';
            if (list.length === 0) { els.historyList.innerHTML = '<div class="text-center text-slate-500 py-4">No matching logs.</div>'; return; }
            list.forEach(h => {
                let dateStr = h.date, timeStr = "", cycleTag = '';
                const dateObj = new Date(h.date);
                
                if (!isNaN(dateObj.getTime())) { 
                    dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }); 
                    timeStr = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }); 
                    
                    // --- NEW: Check if this logged peptide was on an OFF day ---
                    // This is complex as we don't know which preset it was, so we check *all* presets
                    const relevantPresets = JSON.parse(localStorage.getItem('pep_presets') || '[]').filter(p => p.peptide === h.peptide && p.cycleStart);
                    
                    if (relevantPresets.length > 0) {
                        const cycleCheck = getCycleState(relevantPresets[0], dateObj); // Check against the first matching preset
                        
                        if (cycleCheck.state === 'OFF' || cycleCheck.state === 'OFF_CYCLE') {
                            cycleTag = `<span class="text-[10px] uppercase bg-red-900/30 text-red-400 px-1.5 py-0.5 rounded-full ml-2">${cycleCheck.state} DAY LOG</span>`;
                        }
                    }
                    // --- END NEW CHECK ---
                } 

                const noteHtml = h.notes ? `<div class="mt-2 text-xs text-indigo-300 italic flex items-center gap-1"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> ${h.notes}</div>` : '';
                const card = document.createElement('div'); card.className = "bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50 flex justify-between items-start animate-fade-in";
                card.innerHTML = `<div><div class="font-bold text-white flex items-center gap-2">${h.peptide} ${cycleTag}<span class="text-xs bg-indigo-500/10 text-indigo-400 px-2 py-0.5 rounded font-mono border border-indigo-500/20">${h.dosage}</span></div><div class="text-xs text-slate-400 mt-1 flex items-center gap-1"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>${h.site}</div>${noteHtml}</div><div class="flex flex-col items-end gap-2"><div class="text-right text-xs text-slate-500 font-mono bg-slate-900/50 px-2 py-1 rounded border border-slate-800"><div class="text-slate-400">${dateStr}</div><div class="text-indigo-400 font-bold">${timeStr}</div></div><button class="text-slate-600 hover:text-red-400 transition p-1" onclick="deleteEntry('${h.row}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button></div>`;
                els.historyList.appendChild(card);
            });
        }

        function calculateSuggestion(history) {
            if(!history || history.length === 0) { showSuggestion(sites[0].name); return; }
            const lastLog = history[0], lastDateObj = new Date(lastLog.date), todayObj = new Date();
            const isSameDay = lastDateObj.toISOString().split('T')[0] === todayObj.toISOString().split('T')[0];
            if(isSameDay) showSuggestion(lastLog.site);
            else { const idx = sites.findIndex(s => s.name === lastLog.site); showSuggestion(idx === -1 ? sites[0].name : sites[(idx + 1) % sites.length].name); }
        }
        function showSuggestion(siteName) { currentSuggestion = siteName; els.suggestionText.textContent = siteName; els.suggestionBox.classList.remove('hidden'); }
        function useSuggestion() { if(!currentSuggestion) return; els.site.value = currentSuggestion; els.site.focus(); }
        function openSiteModal() { els.modalNote.value = ""; const buttons = els.modalList.querySelectorAll('button'); buttons.forEach(btn => { if(currentSuggestion && btn.dataset.site === currentSuggestion) { btn.classList.remove('bg-slate-800/50', 'border-slate-700/50'); btn.classList.add('bg-indigo-900/40', 'border-indigo-500/50', 'ring-1', 'ring-indigo-500/50'); if(!btn.querySelector('.badge')) { const badge = document.createElement('span'); badge.className = 'badge text-[10px] uppercase bg-indigo-500 text-white px-1.5 py-0.5 rounded ml-auto font-bold tracking-wide'; badge.innerText = 'Rec.'; btn.appendChild(badge); } } else { btn.className = "w-full p-4 bg-slate-800/50 hover:bg-indigo-600/80 rounded-xl text-left transition flex items-center gap-3 border border-slate-700/50"; const badge = btn.querySelector('.badge'); if(badge) badge.remove(); } }); els.modal.classList.remove('hidden'); }

        async function deleteEntry(rowId) { if(!confirm("Delete log?")) return; const res = await api({ action: 'deleteLog', row: rowId }); if(res.success) loadHistory(); }
        function renderStreak(history) { const today = new Date(); els.streakContainer.innerHTML = ''; for(let i=6; i>=0; i--) { const d = new Date(today); d.setDate(today.getDate() - i); const dateStr = d.toISOString().split('T')[0]; const hasLog = history.some(h => { if(!h.date) return false; return h.date.startsWith(dateStr); }); const circle = document.createElement('div'); circle.className = `w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border ${hasLog ? 'bg-green-500/20 border-green-500/50 text-green-400 shadow-[0_0_10px_rgba(34,197,94,0.2)]' : 'bg-slate-800 border-slate-700 text-slate-600'}`; circle.textContent = d.getDate(); els.streakContainer.appendChild(circle); } }

        async function handleManualLog(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-btn'); const originalText = btn.innerHTML; btn.innerHTML = "Saving..."; btn.disabled = true;
            const pName = els.pep.value === 'Other' ? document.getElementById('custom-peptide').value : els.pep.value;
            const sName = els.site.value === 'Other' ? document.getElementById('custom-site').value : els.site.value;
            const dose = `${document.getElementById('dosage-value').value} ${document.getElementById('dosage-unit').value}`;
            
            // --- NEW CHECK: PREVENT LOGGING ON OFF DAY ---
            const presets = JSON.parse(localStorage.getItem('pep_presets') || '[]').filter(p => p.peptide === pName && p.cycleStart);
            if (presets.length > 0) {
                 const cycleCheck = getCycleState(presets[0], document.getElementById('timestamp').value);
                 if (cycleCheck.state === 'OFF' || cycleCheck.state === 'OFF_CYCLE') {
                     alert(`Protocol Warning: ${pName} is currently on an ${cycleCheck.state} cycle day. Log prevented.`);
                     btn.innerHTML = originalText; btn.disabled = false;
                     return;
                 }
            }
            // --- END NEW CHECK ---

            const data = { action: 'logInjection', peptide: pName, dosage: dose, site: sName, timestamp: document.getElementById('timestamp').value, notes: els.manualNote.value };
            const res = await api(data);
            btn.innerHTML = originalText; btn.disabled = false;
            if(res.success) { if(res.offline) alert("Offline. Saved to queue."); else alert("Log Saved!"); els.logForm.reset(); document.getElementById('timestamp').value = new Date(new Date() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0,16); if(!res.offline) loadHistory(); } else alert("Error.");
        }

        async function finalizeQuickLog(site) {
            els.modal.classList.add('hidden');
            if(!pendingPreset) return;
            
            // --- NEW CHECK: PREVENT LOGGING ON OFF DAY FOR QUICK LOG ---
            const cycleCheck = getCycleState(pendingPreset);
            if (cycleCheck.state === 'OFF' || cycleCheck.state === 'OFF_CYCLE') {
                 alert(`Protocol Warning: ${pendingPreset.peptide} is currently on an ${cycleCheck.state} cycle day. Log prevented.`);
                 pendingPreset = null;
                 return;
            }
            // --- END NEW CHECK ---

            const ts = new Date(new Date() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0,16);
            const data = { action: 'logInjection', peptide: pendingPreset.peptide, dosage: `${pendingPreset.value} ${pendingPreset.unit}`, site: site, timestamp: ts, notes: els.modalNote.value };
            const res = await api(data);
            if(res.success) { if(res.offline) alert("Offline. Saved to queue."); else alert(`Saved: ${pendingPreset.peptide}`); if(!res.offline) loadHistory(); } else alert("Error.");
            pendingPreset = null;
        }

        async function handleConfigSave(e) {
            e.preventDefault();
            const btn = document.getElementById('config-submit-btn'); btn.textContent = "Saving..."; btn.disabled = true;
            const isCycle = els.cycleToggle.checked;
            
            let cycleOn = null, cycleOff = null;
            if (isCycle) {
                cycleOn = els.cycleOn.value;
                cycleOff = els.cycleOff.value;
                if (!cycleOn || !cycleOff || parseInt(cycleOn) <= 0 || parseInt(cycleOff) < 0) {
                     alert("Cycle ON/OFF days must be valid numbers.");
                     btn.textContent = "Save Preset"; btn.disabled = false;
                     return;
                }
            }
            
            const data = { 
                action: 'saveConfig', 
                label: document.getElementById('config-label').value, 
                peptide: document.getElementById('config-peptide').value, 
                value: document.getElementById('config-value').value, 
                unit: document.getElementById('config-unit').value, 
                site: 'Ask', 
                cycleStart: isCycle ? els.cycleStart.value : null, 
                cycleWeeks: isCycle ? els.cycleWeeks.value : null,
                cycleON: cycleOn,
                cycleOFF: cycleOff
            };
            const res = await api(data);
            btn.textContent = "Save Preset"; btn.disabled = false;
            if(res.success) { alert("Preset Saved"); els.configForm.reset(); els.cycleToggle.checked = false; els.cycleOptions.classList.add('hidden'); loadConfig(); switchView('log'); } else alert("Error");
        }

        function initSyringe() {
             els.calc.syringeMarks.innerHTML = '';
             for(let i=0; i<=10; i++) {
                 const mark = document.createElement('div');
                 mark.className = 'mark major';
                 mark.style.bottom = `${i * 10}%`;
                 mark.innerHTML = `<span class="mark-label">${i*10}</span>`;
                 els.calc.syringeMarks.appendChild(mark);
             }
             for(let i=0; i<50; i++) {
                 if(i % 5 !== 0) {
                    const mark = document.createElement('div');
                    mark.className = 'mark';
                    mark.style.bottom = `${i * 2}%`;
                    mark.style.width = '50%';
                    els.calc.syringeMarks.appendChild(mark);
                 }
             }
        }

        function runCalc() {
            const vm = parseFloat(els.calc.m.value), dv = parseFloat(els.calc.v.value), td = parseFloat(els.calc.d.value);
            els.calc.alert.classList.add('hidden');
            
            if(!vm || !dv || !td || vm <= 0 || dv <= 0 || td <= 0) { 
                els.calc.res.innerText = "0"; els.calc.mic.innerText = "0"; els.calc.conc.innerText = "--"; els.calc.mcgPerUnit.innerText = "0";
                els.calc.visualLiquid.style.height = '0%'; els.calc.visualPlunger.style.bottom = '0%';
                return; 
            }
            
            const m_mcg = els.calc.mu.value === 'mg' ? vm * 1000 : vm;
            const dv_ml = els.calc.vu.value === 'ml' ? dv : dv;
            const conc_mcg_ml = m_mcg / dv_ml;

            if (conc_mcg_ml > 5000) { els.calc.alert.classList.remove('hidden'); }
            
            const mcgPerUnit = conc_mcg_ml * 0.01;
            const target_mcg = els.calc.du.value === 'mg' ? td * 1000 : td;
            const unitsNeeded = target_mcg / mcgPerUnit;
            const vol_ul = (unitsNeeded * 0.01) * 1000;

            els.calc.res.innerText = `${unitsNeeded.toFixed(2)}`; 
            els.calc.mic.innerText = `${vol_ul.toFixed(1)}`;
            els.calc.conc.innerText = conc_mcg_ml.toFixed(0);
            els.calc.mcgPerUnit.innerText = mcgPerUnit.toFixed(1);

            let visualPercent = unitsNeeded;
            if(visualPercent > 100) visualPercent = 100;
            if(visualPercent < 0) visualPercent = 0;
            
            els.calc.visualLiquid.style.height = `${visualPercent}%`;
            els.calc.visualPlunger.style.bottom = `${visualPercent}%`;
        }

        function closeModal() { els.modal.classList.add('hidden'); }
        init(); switchView('log');
    </script>
</body>
</html>
