/**
 * Gère les requêtes GET (lecture de données)
 */
function doGet(e) {
  return handleRequest(e);
}

/**
 * Gère les requêtes POST (écriture de données)
 */
function doPost(e) {
  return handleRequest(e);
}

/**
 * Fonction principale de traitement des requêtes
 */
function handleRequest(e) {
  // Verrouillage pour éviter les écritures simultanées conflictuelles
  var lock = LockService.getScriptLock();
  lock.tryLock(10000); // Attend maximum 10 secondes

  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var output = {};
    var action = e.parameter.action;
    
    // Traitement des données envoyées en POST (JSON)
    if (e.postData) {
      var data = JSON.parse(e.postData.contents);
      action = data.action || action;

      // ACTION : Sauvegarder un raccourci (Quick Log)
      if (action === 'saveConfig') {
          var configSheet = ss.getSheetByName("QuickLogs Config") || ss.insertSheet("QuickLogs Config");
          if (configSheet.getLastRow() === 0) {
            configSheet.appendRow(["label", "peptide", "value", "unit", "site", "cycleStart", "cycleWeeks", "cycleON", "cycleOFF"]);
          }
          configSheet.appendRow([
            data.label, 
            data.peptide.trim(), 
            data.value, 
            data.unit, 
            data.site || "Ask",
            data.cycleStart || "", 
            data.cycleWeeks || "", 
            data.cycleON || "", 
            data.cycleOFF || ""
          ]);
          output = { success: true };

      // ACTION : Sauvegarder un peptide dans la bibliothèque (avec sa demi-vie)
      } else if (action === 'savePeptide') {
          if (!data.name || data.name.trim() === "") throw new Error("Le nom du peptide est requis");
          var pepSheet = ss.getSheetByName("Peptides List") || ss.insertSheet("Peptides List");
          if (pepSheet.getLastRow() === 0) {
            pepSheet.appendRow(["Peptide Name", "Half-Life", "Unit"]);
          }
          
          // Vérification anti-doublon (insensible à la casse)
          var existingPeps = pepSheet.getDataRange().getValues().map(function(r) { return r[0].toString().toLowerCase().trim(); });
          if (existingPeps.indexOf(data.name.toLowerCase().trim()) === -1) {
            pepSheet.appendRow([data.name.trim(), data.halfLife || 0, data.hlUnit || "hours"]);
          }
          output = { success: true };

      // ACTION : Supprimer un peptide de la bibliothèque
      } else if (action === 'deletePeptide') {
          var pepSheet = ss.getSheetByName("Peptides List");
          var rowToDelete = parseInt(data.row);
          if (pepSheet && rowToDelete > 1) {
            pepSheet.deleteRow(rowToDelete);
            output = { success: true };
          }

      // ACTION : Supprimer un raccourci (Config)
      } else if (action === 'deleteConfig') {
          var configSheet = ss.getSheetByName("QuickLogs Config");
          var rowToDelete = parseInt(data.row);
          if (configSheet && rowToDelete > 1) {
            configSheet.deleteRow(rowToDelete);
            output = { success: true };
          }

      // ACTION : Supprimer une entrée de l'historique
      } else if (action === 'deleteLog') {
          var logSheet = ss.getSheetByName("Logs Injections Peptides");
          var rowToDelete = parseInt(data.row);
          if (logSheet && rowToDelete > 1) {
            logSheet.deleteRow(rowToDelete);
            output = { success: true };
          }

      // ACTION PAR DÉFAUT : Enregistrer une injection
      } else {
          var logSheet = ss.getSheetByName("Logs Injections Peptides") || ss.insertSheet("Logs Injections Peptides");
          if (logSheet.getLastRow() === 0) {
            logSheet.appendRow(["Date", "Peptide", "Dosage", "Site", "Notes"]);
          }
          var timestamp = data.timestamp ? new Date(data.timestamp) : new Date();
          logSheet.appendRow([timestamp, data.peptide, data.dosage, data.site, data.notes || ""]);
          output = { success: true };
      }
      
    } else {
      // Traitement des requêtes GET (lecture)
      
      // ACTION : Récupérer l'historique des injections
      if (action === 'getHistory') {
        var logSheet = ss.getSheetByName("Logs Injections Peptides");
        var history = [];
        if (logSheet && logSheet.getLastRow() > 1) {
          var rows = logSheet.getRange(2, 1, logSheet.getLastRow() - 1, 5).getValues();
          // On parcourt à l'envers pour avoir les plus récents en premier
          for (var i = rows.length - 1; i >= 0; i--) {
            history.push({
              row: i + 2,
              date: rows[i][0] instanceof Date ? rows[i][0].toISOString() : rows[i][0],
              peptide: rows[i][1], 
              dosage: rows[i][2], 
              site: rows[i][3], 
              notes: rows[i][4] || ""
            });
          }
        }
        output = { success: true, history: history };

      // ACTION : Récupérer la liste des peptides enregistrés (avec demi-vie)
      } else if (action === 'getPeptides') {
        var pepSheet = ss.getSheetByName("Peptides List");
        var peps = [];
        if (pepSheet && pepSheet.getLastRow() > 1) {
          var rows = pepSheet.getRange(2, 1, pepSheet.getLastRow() - 1, 3).getValues();
          for (var i = 0; i < rows.length; i++) {
            if (rows[i][0]) {
              peps.push({ row: i + 2, name: rows[i][0], halfLife: rows[i][1], hlUnit: rows[i][2] });
            }
          }
        }
        output = { success: true, peptides: peps };

      // ACTION PAR DÉFAUT : Récupérer les raccourcis (Presets)
      } else {
        var configSheet = ss.getSheetByName("QuickLogs Config");
        var presets = [];
        if (configSheet && configSheet.getLastRow() > 1) {
          var rows = configSheet.getDataRange().getValues();
          for (var i = 1; i < rows.length; i++) {
            if(rows[i][0]) {
              presets.push({ 
                row: i + 1, 
                label: rows[i][0], 
                peptide: rows[i][1], 
                value: rows[i][2], 
                unit: rows[i][3], 
                site: rows[i][4], 
                cycleStart: rows[i][5], 
                cycleWeeks: rows[i][6], 
                cycleON: rows[i][7], 
                cycleOFF: rows[i][8] 
              });
            }
          }
        }
        output = { success: true, presets: presets };
      }
    }

    // Renvoie le résultat au format JSON
    return ContentService.createTextOutput(JSON.stringify(output)).setMimeType(ContentService.MimeType.JSON);

  } catch (e) {
    // Gestion des erreurs
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: e.toString() })).setMimeType(ContentService.MimeType.JSON);
  } finally {
    // Libération du verrouillage
    lock.releaseLock();
  }
}
